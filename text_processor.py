import requests
import json
import time
import os
from openai import OpenAI

def process_section_text(text):
    """处理佛经文本，提取国名、地名、人名和佛教核理论"""
    start_time = time.time()
    
    client = OpenAI(
        api_key=os.getenv('OPENAI_API_KEY'),
        base_url="https://api.openai-proxy.com/v1"
    )
    
    empty_result = {
        "国家": [], 
        "地名": [], 
        "人名": [], 
        "四圣谛": [],
        "四正勤": [],
        "四念住": [],
        "五根": [],
        "五力": [],
        "七覺支": [],
        "八正道": [],
        "五蕴": [], "十二处": [], "十八界": [],
        "其他重要理论和概念": []
    }

    prompt = f"""
    请分析以下佛经文本，提取以下信息并以JSON格式返回：
    1. 国名、地名、人名。佛，世尊，比丘不是人名。
    2. 佛教重要理论和概念，仅仅输出涉及提到的部分，包括：
       - 四圣谛（苦集灭道）
       - 十二因缘
       - 八正道
       - 三十七道品（四念处、四正勤、四如意足、五根、五力、七覺支、八正道）
       - 其他重要理论及其解释(六随念 等)

    {text}
    
    请按照以下格式返回：
    {empty_result}
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": "你是一个专门分析佛经文本的助手，精通佛教理论体系，善于识别文本中的核心概念和教义。请只返回符合要求的JSON格式数据。"},
                {"role": "user", "content": prompt}
            ],
            temperature=0
        )
        
        try:
            result = response.choices[0].message.content
            print(f">>经文：\n\n{text}\n\nLLM解析结果：\n\n{result}")
            # Clean the response by removing ```json and ``` markers
            cleaned_result = result.replace('```json', '').replace('```', '').strip()
            parsed_result = json.loads(cleaned_result)
            end_time = time.time()
            print(f"处理耗时: {end_time - start_time:.2f} 秒")
            return parsed_result
        except json.JSONDecodeError:
            print(f"解析结果失败: {result}")
            end_time = time.time()
            print(f"处理耗时: {end_time - start_time:.2f} 秒")
            return empty_result
            
    except Exception as e:
        print(f"处理文本时出错: {str(e)}")
        end_time = time.time()
        print(f"处理耗时: {end_time - start_time:.2f} 秒")
        return empty_result



def test_process_section():
    text1 = """
    一時，佛住舍衛國祇樹給孤獨園。
    爾時，世尊告諸比丘：「當觀色無常。如是觀者，則為正觀。正觀者，則生厭離；厭離者，喜貪盡；喜貪盡者，說心解脫。
    如是觀受、想、行、識無常。如是觀者，則為正觀。正觀者，則生厭離；厭離者，喜貪盡；喜貪盡者，說心解脫。
    如是，比丘！心解脫者，若欲自證，則能自證：『我生已盡，梵行已立，所作已作，自知不受後有。』
    如觀無常，苦、空、非我亦復如是。」
    """

    text2 = """
    （七六一）
    如是我聞：

    一時，佛住舍衛國祇樹給孤獨園。

    爾時，世尊告諸比丘：「我當說學及無學。諦聽，善思念之。何等為學？謂學正見成就，學正志、正語、正業、正命、正方便、正念、正定成就，是名為學。何等為無學？謂無學正見成就，無學正志、正語、正業、正命、正方便、正念、正定成就，是名無學。」

    佛說此經已，諸比丘聞佛所說，歡喜奉行。

    如學、無學，如是正士、如是大士，亦如是說。
    """

    text3="""
    （五五〇）

    如是我聞：

    一時，佛住舍衛國祇樹給孤獨園。爾時，尊者摩訶迦旃延在舍衛國祇樹給孤獨園。

    尊者摩訶迦旃延語諸比丘：「佛世尊、如來、應、等正覺所知所見，說六法出苦處昇於勝處，說一乘道淨諸眾生，離諸惱苦，憂悲悉滅，得真如法。何等為六？謂聖弟子念如來、應、等正覺所行法淨，如來、應、等正覺、明行足、善逝、世間解、無上士、調御丈夫、天人師、佛世尊。聖弟子念如來、應所行法故，離貪欲覺、離瞋恚覺、離害覺。如是，聖弟子出染著心。何等為染著心？謂五欲功德，於此五欲功德離貪、恚、癡，安住正念正智，乘於直道，修習念佛，正向涅槃，是名如來、應、等正覺所知所見，說第一出苦處昇於勝處，一乘道淨於眾生，離苦惱，滅憂悲，得如實法。

    「復次，聖弟子念於正法，念於世尊現法、律，離諸熱惱，非時，通達，即於現法，緣自覺悟。爾時，聖弟子念此正法時，不起欲覺、瞋恚、害覺。如是，聖弟子出染著心。何等為染著心？謂五欲功德。於此五欲功德離貪、恚、癡，安住正念正知，乘於直道，修習念法，正向涅槃，是名如來、應、等正覺所知所見，說第二出苦處昇於勝處，一乘道淨於眾生，離苦惱，滅憂悲，得如實法。

    「復次，聖弟子念於僧法，善向、正向、直向、等向，修隨順行，謂向須陀洹、得須陀洹果，向斯陀含、得斯陀含，向阿那含、得阿那含，向阿羅漢、得阿羅漢。如是四雙八士，是名世尊弟子僧戒具足、定具足、慧具足、解脫具足、解脫知見具足，供養、恭敬、禮拜處，世間無上福田。聖弟子如是念僧時，爾時聖弟子不起欲覺、瞋恚、害觉。如是，聖弟子出染著心。何等為染著心？谓五欲功德。於此五欲功德离貪、恚、癡，安住正念正知，乘於直道，修习念僧，正向涅槃，是名如來、应、等正觉所知所见，说第三出苦处升于胜处，一乘道净诸众生，离苦惱，灭忧悲，得如实法。

    「复次，圣弟子念于戒德，念不缺戒、不斷戒、纯厚戒、不离戒、非盜取戒、善究竟戒、可讚歎戒、梵行不憎恶戒。若圣弟子念此戒时，自念身中所成就戒，当於尔时不起欲觉、瞋恚、害觉。如是，圣弟子出染著心。何等为染著心？谓五欲功德。于此五欲功德离貪、恚、癡，安住正念正知，乘于直道，修戒念，正向涅槃，是名如来、应、等正觉所知所见，说第四出苦处升于胜处，一乘道净诸众生，离苦惱，灭忧悲，得如实法。

    「复次，圣弟子自念施法，心自欣庆。我今离慳貪垢、离在居家，解脫心施、常施、捨施、乐施、具足施、平等施。若圣弟子念於自所施法时，不起欲觉、瞋恚、害觉。如是，圣弟子出染著心。於何染著？谓五欲功德。於此五欲功德离貪、恚、癡，安住正念正知，乘於直道，修施念，正向涅槃，是名如来、应、等正觉所知所见，说第五出苦处昇於胜处，一乘道净於众生，离苦惱，灭忧悲，得如实法。

    「复次，圣弟子念於天德，念四王天、三十三天，炎摩天、兜率陀天、化乐天、他化自在天，清淨信心，於此命终，生彼诸天。我亦如是，信、戒、施、闻、慧，於此命终，生彼天中。如是，圣弟子念天功德时，不起欲觉、瞋恚、害觉。如是，圣弟子出染著心。於何染著？谓五欲功德。於此五欲功德离貪、恚、癡，安住正念正知，乘於直道，修天念，正向涅槃，是名如來、应、等正觉所知所见，说第六出苦处昇於胜处，一乘道净於众生，离苦惱，灭忧悲，得如实法。」

    尊者摩訶迦旃延说此经已，诸比丘闻其所说，欢喜奉行。

    """
    
    result = process_section_text(text1)


if __name__ == "__main__":
    test_process_section()

